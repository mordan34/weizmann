---
- hosts: satellite
  become: true
  remote_user: ansible

  tasks: 

      - name: Clone/Update repository to destination
        git:
            repo: 'https://github.com/mordan34/weizmann.git'
            dest: /opt/weizmann
            clone: yes
            update: yes
            force: yes

      - name: Add new host record in Infoblox for {{ hostname }}
        command: "/usr/bin/ansible-playbook /root/weizmann/playbooks/addnewrecord.yml -e hostname={{ hostname }}"
        delegate_to: localhost

      - name: Fetch host {{ hostname }}
        set_fact:
            host: "{{ lookup('nios', 'record:host', filter={'name~':hostname}, provider=nios_provider) }}"
        delegate_to: localhost

      - name: Show {{ hostname }} IPV4 address
        set_fact:
            IP: "{{ host.ipv4addrs[0].ipv4addr }}"
        delegate_to: localhost
      
      - name: Execute Hammer script to create server {{ hostname }}
        command: /bin/bash -c "/opt/weizmann/scripts/createhost.sh {{ hostname }} {{ IP }}"
